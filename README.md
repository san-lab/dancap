# Overview
This is a proof of concept lab to explore attestation options for
Hyperledger Avalon.

The code can be used to learn the call flow for ECDSA based attestation. To a
lesser degree, the project can also be used to verify the availability of
attestation components on a host (e.g. SGX and libs).

The code is written first and foremost to make the attestation API readable and
simple. It is not written to be fully secure or robust. You can treat this as a
simplified example before looking at official SGX examples.

The main attestation logic is in App/App.cpp. It loads a minimal enclave and
uses the SGX SDK methods for creating an ECDSA based attestation of that
enclave.

The complement to the enclave application is the relying party's verifier in
RelyingParty/Verifier.cpp. This program will read in a binary quote generated by
the application and verify it using SGX DCAP libraries. Those libraries rely on
a service deployed in the cloud environment or within your local enviroment.

Quote generation (creating an attestation) has been verified on Azure ACC nodes
only. Quote verification has been verified with Intel open source reference
components only.

The project also includes a Docker-based dev environment to facilitate building 
and some debugging. The app also works within that environment if the app is
built in simulation mode. Verification will correctly return errors when given
simulation quotes (because you should not trust simulated quotes). 
The container is meant for development not for deployment.
It may be possible to modify the container for deployment by
mapping in /dev/sgx and the quote provider library (libdcap_quoteprov.so)
but this has not been tested.

Similarly the verifier may be run in a container or other environment
supplying the required services and libraries to test the portability of the 
quote generated by the attestor application.

## TODO
* Add report data to app and verifier.
* Add verifier using Quote Verification *Enclave* and/or discuss deployment
  models where Quote Verification *Library* alone makes sense (this is probably
  the most applicable model for Avalon).
* There is a known library compatibility issue with this lab and Azure at this
  time (Feb 24, 2020) that will cause verification errors.
* Print DCAP Codes nicely


# Build

## Ubuntu 18.04 or 16.04
1. Install machine per instructions in [Cloud Provisioning](#cloud-provisioning)

2. build in hardware mode

    `make clean && make`
    
> If there is an error check that you have done

```
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/intel/linux-sgx/psw/uae_service/linux/
source /opt/intel/sgxsdk/environment
```

> In the current terminal session


# Running
(Note: when run within the dev container only simulation mode binary of the
attestor app will work.
However if you build in HW mode the binary will work on Ubuntu natively.)
    
1. Create an attestation (also called generating a quote)

    `./attestor`

    This outputs a binary file `attestation.bytes`.

2. Verify the attestation
 
        0. Build docker base
        
            `./build-docker`
            
        1. Build verifier container

            `./build-docker-verifier`

        2. Run verifier container

            `./run-docker-verifier`

        3. If necessary copy attestation.bytes to the verifier\'s host

            I.e. if you are running the verifier on a different host than the attestor. The verifier
            will look for the attestation in the same directory as the verifier binary. The project
            root (e.g.  /home/you/dancap) is mapped into the verifier container at /project/dancap.

        4. Run the verifier from the container\'s shell
        
            `./verifier`

    Expect output to look like this:

    ```
    root@4f91bb8bbfd5:/project/dancap# ./verifier
    Reading 4580 bytes... Read attestation file successfully.
    Success: Quote verification PASSED

    Verification result code: a002
    ```
    
    If instead you get an error 19:
    
    ```
    root@4f91bb8bbfd5:/project/dancap# ./verifier
    Reading 4580 bytes... Read attestation file successfully.
    ERROR: Quote verification FAILED with error: e019
    Verification error code: e006
    ```

    Please check your proxy settings and then make sure that the PCCS service is running:

    `pm2 status`

    If you don't see PCCS listed then you can start it as follows:

    ```
    cd /opt/intel/sgx-dcap-pccs/
    pm2 start pccs_server.config.js
    ```


# Cloud Provisioning
## Azure Confidential Compute
1. Provision an ACC node with
    * Ubuntu 18.04
    * Open Enclave SDK 
    ** This is necessary to get the attestation dependencies installed correctly within Azure.
    See:
    https://software.intel.com/en-us/articles/get-started-with-azure-confidential-computing
    for more details.

2. Upgrade the machine
    `apt-get update && apt-get upgrade`
    
   > For ubuntu 16.04 it is necessary to upgrade openssl to version to 
   > https://www.openssl.org/source/openssl-1.1.1f.tar.gz
   > check that the good version is installed executing `openssl version`

3. Install the Intel(r) SGX SDK
```
    cd /opt/intel
    wget https://download.01.org/intel-sgx/sgx-linux/2.7.1/distro/ubuntu18.04-server/sgx_linux_x64_sdk_2.7.101.3.bin
    chmod +x sgx_linux_x64_sdk_2.7.101.3.bin
    ./sgx_linux_x64_sdk_2.7.101.3.bin 
    rm sgx_linux_x64_sdk_2.7.101.3.bin
    source /opt/intel/sgxsdk/environment
```
> For ubuntu 16.04 download 
> https://download.01.org/intel-sgx/sgx-linux/2.7.1/distro/ubuntu16.04-server/sgx_linux_x64_sdk_2.7.101.3.bin instead

4. Set library search order to pick up Azure's quote provider library rather
    than the one available in the SGX common path. You can do this the right
    way by managing /etc/ld.so.conf Or you can do it the expedient way by
    removing the one we don't want.

    We want this one:
    `$ /usr/lib/libdcap_quoteprov.so`

    we do NOT want this one:
    ~~$ /opt/intel/libsgx-enclave-common/aesm/libdcap_quoteprov.so~~
    
    > `mv /opt/intel/libsgx-enclave-common/aesm/libdcap_quoteprov.so /opt/intel/libsgx-enclave-common/aesm/libdcap_quoteprov.so.wrong`
    
5. Install PSW

    5.1 Clone https://github.com/intel/linux-sgx.git in '/opt/intel'
    
    5.2 Install dependencies
    ```
    sudo apt-get install libssl-dev libcurl4-openssl-dev protobuf-compiler libprotobuf-dev debhelper cmake reprepro
    ```
    5.3 Build project `make psw`
    
    5.4 Check that the library /opt/intel/linux-sgx/psw/uae_service/linux/libsgx_uae_service.so exists
    
    > Even if `make psw` have ended with errors, the only thing that matters is that the library exists
    
    5.5 Add the library folder to the LD_LIBRARY_PATH

    `export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/intel/linux-sgx/psw/uae_service/linux/`
   

# Misc
The project has a helper function to print SGX error codes and messages.
This helper function can be regenerated if the SGX SDK changes using the
python script in App/:

`App/generate_handle_sgx_error.py > App/handle_sgx_error.h`

DCAP codes output by the verifier can be looked up here:
https://github.com/intel/SGXDataCenterAttestationPrimitives/blob/master/QuoteGeneration/quote_wrapper/common/inc/sgx_ql_lib_common.h

and here:

https://github.com/intel/SGXDataCenterAttestationPrimitives/blob/master/QuoteVerification/QvE/Include/qve_header.h

